name: OWASP ZAP DAST Scan

on:
  # Run on push to main branch
  push:
    branches:
      - main
  # Run on pull requests
  pull_request:
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan (optional, overrides default)'
        required: false
        type: string
  # Schedule scan (runs daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

env:
  # Replace with your EC2 instance URL
  TARGET_URL: ${{ inputs.target_url || secrets.PET_CLINIC_URL || 'http://your-ec2-public-ip:8080' }}
  ZAP_VERSION: 'stable'

jobs:
  zap-baseline-scan:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create ZAP reports directory
        run: mkdir -p zap-reports

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: 'zap-rules.tsv'
          cmd_options: '-a -j -l INFO -d'
          issue_title: 'ZAP Baseline Scan Report'
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_action: false
          allow_issue_writing: true

      - name: Upload ZAP Scan Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

  zap-full-scan:
    name: ZAP Full Scan
    runs-on: ubuntu-latest
    # Run only on manual trigger or schedule to avoid long scan times on every push
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create ZAP reports directory
        run: mkdir -p zap-reports

      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: 'zap-rules.tsv'
          cmd_options: '-a -j -l INFO'
          issue_title: 'ZAP Full Scan Report'
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_action: false
          allow_issue_writing: true

      - name: Upload ZAP Full Scan Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-scan-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

  zap-api-scan:
    name: ZAP API Scan
    runs-on: ubuntu-latest
    # Only run if API definition exists
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for API definition
        id: check_api
        run: |
          if [ -f "openapi.json" ] || [ -f "swagger.json" ] || [ -f "openapi.yaml" ]; then
            echo "api_exists=true" >> $GITHUB_OUTPUT
          else
            echo "api_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ZAP API Scan
        if: steps.check_api.outputs.api_exists == 'true'
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: ${{ env.TARGET_URL }}
          format: 'openapi'
          api_definition_url: '${{ env.TARGET_URL }}/v3/api-docs'
          rules_file_name: 'zap-rules.tsv'
          cmd_options: '-a -j -l INFO'
          issue_title: 'ZAP API Scan Report'
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_action: false
          allow_issue_writing: true

      - name: Upload ZAP API Scan Report
        uses: actions/upload-artifact@v4
        if: always() && steps.check_api.outputs.api_exists == 'true'
        with:
          name: zap-api-scan-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

  zap-custom-scan:
    name: ZAP Custom Docker Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull ZAP Docker Image
        run: docker pull ghcr.io/zaproxy/zaproxy:${{ env.ZAP_VERSION }}

      - name: Create workspace directory
        run: mkdir -p $(pwd)/zap-workspace

      - name: Run ZAP Spider Scan
        run: |
          docker run --rm \
            -v $(pwd)/zap-workspace:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:${{ env.ZAP_VERSION }} \
            zap-baseline.py \
            -t ${{ env.TARGET_URL }} \
            -r zap-spider-report.html \
            -J zap-spider-report.json \
            -w zap-spider-report.md \
            -a \
            -j \
            -l INFO \
            -d

      - name: Run ZAP Active Scan (if needed)
        run: |
          docker run --rm \
            -v $(pwd)/zap-workspace:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:${{ env.ZAP_VERSION }} \
            zap-full-scan.py \
            -t ${{ env.TARGET_URL }} \
            -r zap-active-report.html \
            -J zap-active-report.json \
            -w zap-active-report.md \
            -a \
            -j \
            -l INFO

      - name: Upload Custom Scan Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-custom-scan-reports
          path: zap-workspace/*.{html,json,md}
          retention-days: 30

  process-results:
    name: Process and Notify Results
    runs-on: ubuntu-latest
    needs: [zap-baseline-scan]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download ZAP Reports
        uses: actions/download-artifact@v4
        with:
          name: zap-baseline-report
          path: ./zap-reports

      - name: Parse ZAP Results
        id: parse_results
        run: |
          if [ -f "./zap-reports/report_json.json" ]; then
            HIGH=$(jq '[.site[].alerts[] | select(.riskcode == "3")] | length' ./zap-reports/report_json.json || echo "0")
            MEDIUM=$(jq '[.site[].alerts[] | select(.riskcode == "2")] | length' ./zap-reports/report_json.json || echo "0")
            LOW=$(jq '[.site[].alerts[] | select(.riskcode == "1")] | length' ./zap-reports/report_json.json || echo "0")
            INFO=$(jq '[.site[].alerts[] | select(.riskcode == "0")] | length' ./zap-reports/report_json.json || echo "0")
            
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            echo "info=$INFO" >> $GITHUB_OUTPUT
            
            echo "### ZAP Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
            echo "- Low: $LOW" >> $GITHUB_STEP_SUMMARY
            echo "- Informational: $INFO" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const high = '${{ steps.parse_results.outputs.high }}';
            const medium = '${{ steps.parse_results.outputs.medium }}';
            const low = '${{ steps.parse_results.outputs.low }}';
            const info = '${{ steps.parse_results.outputs.info }}';
            
            const comment = `## ğŸ”’ ZAP DAST Scan Results
            
            | Severity | Count |
            |----------|-------|
            | ğŸ”´ High | ${high} |
            | ğŸŸ  Medium | ${medium} |
            | ğŸŸ¡ Low | ${low} |
            | â„¹ï¸ Info | ${info} |
            
            [View detailed report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
