name: OWASP ZAP DAST Scan

on:
  # Run on push to main branch
  push:
    branches:
      - main
  # Run on pull requests
  pull_request:
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan (optional, overrides default)'
        required: false
        type: string
  # Schedule scan (runs daily at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

env:
  # DVWA Application Server
  DVWA_HOST: '13.49.91.130'
  # ZAP Windows Server
  ZAP_HOST: '51.21.57.0'
  TARGET_URL: ${{ inputs.target_url || 'http://13.49.91.130' }}
  ZAP_VERSION: 'stable'

jobs:
  deploy-dvwa:
    name: Deploy DVWA Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.DVWA_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy DVWA Application to EC2
        run: |
          echo "Deploying to DVWA server at ${{ env.DVWA_HOST }}..."
          
          # Copy application files to EC2 (if you have app changes)
          # scp -i ~/.ssh/id_rsa -r ./app-files ubuntu@${{ env.DVWA_HOST }}:/path/to/dvwa/
          
          # SSH into EC2 and restart/update DVWA container
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.DVWA_HOST }} << 'EOF'
            echo "Pulling latest DVWA image..."
            sudo docker pull vulnerables/web-dvwa:latest
            
            echo "Stopping existing DVWA container..."
            sudo docker stop $(sudo docker ps -q --filter ancestor=vulnerables/web-dvwa) || true
            sudo docker rm $(sudo docker ps -aq --filter ancestor=vulnerables/web-dvwa) || true
            
            echo "Starting new DVWA container..."
            sudo docker run -d -p 80:80 vulnerables/web-dvwa:latest
            
            echo "Waiting for DVWA to be ready..."
            sleep 30
            
            echo "DVWA deployment completed!"
          EOF

      - name: Verify DVWA is Running
        run: |
          echo "Checking if DVWA is accessible..."
          for i in {1..10}; do
            if curl -f -s -o /dev/null http://${{ env.DVWA_HOST }}; then
              echo "âœ… DVWA is up and running!"
              exit 0
            fi
            echo "Waiting for DVWA... (attempt $i/10)"
            sleep 10
          done
          echo "âŒ DVWA is not responding"
          exit 1

  zap-scan-via-ssm:
    name: ZAP Scan from Windows Server via SSM
    runs-on: ubuntu-latest
    needs: deploy-dvwa
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Run ZAP Scan via Systems Manager
        id: run-zap
        run: |
          echo "Triggering ZAP scan on Windows server via SSM..."
          echo "Target: DVWA at 13.49.91.130"
          
          # Send command via SSM - kill all ZAP processes before scan
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.WINDOWS_INSTANCE_ID }}" \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["Get-Process java -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue; Start-Sleep -Seconds 2; if (-not (Test-Path \"C:\zap-reports\")) { New-Item -ItemType Directory -Path \"C:\zap-reports\" -Force | Out-Null }; cd \"C:\Program Files\ZAP\Zed Attack Proxy\"; Write-Host \"=== Running ZAP Baseline Scan ===\"; .\\zap.bat -cmd -quickurl http://13.49.91.130 -quickout \"C:\zap-reports\baseline-report.html\" -quickprogress *>&1 | Tee-Object \"C:\zap-reports\zap-output.txt\"; Write-Host \"=== Scan completed ===\"; if (Test-Path \"C:\zap-reports\baseline-report.html\") { Write-Host \"SUCCESS: Report created\"; $size = (Get-Item \"C:\zap-reports\baseline-report.html\").Length; Write-Host \"Report size: $size bytes\" } else { Write-Host \"ERROR: No report found\"; Write-Host \"Files in C:\zap-reports:\"; Get-ChildItem \"C:\zap-reports\" | Select-Object Name, Length; Write-Host \"--- zap-output.txt ---\"; if (Test-Path \"C:\zap-reports\zap-output.txt\") { Get-Content \"C:\zap-reports\zap-output.txt\" } }"]' \
            --timeout-seconds 600 \
            --output text \
            --query "Command.CommandId")
          
          echo "Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          
          # Wait for command to complete (poll every 5 seconds for up to 5 minutes)
          echo "Waiting for scan to complete..."
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.WINDOWS_INSTANCE_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            echo "Status: $STATUS (attempt $i/60)"
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 5
          done
          
          # Get command output
          echo "=== ZAP Scan Output ==="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.WINDOWS_INSTANCE_ID }}" \
            --query 'StandardOutputContent' \
            --output text || echo "No output available"
          
          echo "âœ… ZAP scan completed on Windows server"

      - name: Download Reports from Windows Server
        run: |
          mkdir -p ./zap-reports
          
          # Create a PowerShell script to read and encode the report
          COPY_COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.WINDOWS_INSTANCE_ID }}" \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["if (Test-Path \"C:\\zap-reports\\baseline-report.html\") { [Convert]::ToBase64String([System.IO.File]::ReadAllBytes(\"C:\\zap-reports\\baseline-report.html\")) } else { Write-Host \"REPORT_NOT_FOUND\" }"]' \
            --output text \
            --query "Command.CommandId")
          
          # Wait for copy command to complete
          echo "Waiting for report download..."
          for i in {1..12}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COPY_COMMAND_ID" \
              --instance-id "${{ secrets.WINDOWS_INSTANCE_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 5
          done
          
          # Get base64 encoded report
          REPORT_BASE64=$(aws ssm get-command-invocation \
            --command-id "$COPY_COMMAND_ID" \
            --instance-id "${{ secrets.WINDOWS_INSTANCE_ID }}" \
            --query 'StandardOutputContent' \
            --output text 2>/dev/null || echo "")
          
          echo "Report content preview: ${REPORT_BASE64:0:100}..."
          
          # Decode and save report
          if [ ! -z "$REPORT_BASE64" ] && [ "$REPORT_BASE64" != "REPORT_NOT_FOUND" ]; then
            # Remove any whitespace/newlines and decode
            echo "$REPORT_BASE64" | tr -d '\n\r ' | base64 -d > ./zap-reports/baseline-report.html 2>/dev/null && \
              echo "âœ… Report downloaded successfully" || \
              echo "âš ï¸ Failed to decode report"
          else
            echo "âš ï¸ No report generated or report not found"
          fi
          
          ls -lh ./zap-reports/ || true

      - name: Upload ZAP Scan Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-reports
          path: |
            zap-reports/*.html
            zap-reports/*.json
            zap-reports/*.xml
          retention-days: 30

      - name: Save ZAP Scan Reports Locally
        if: always()
        run: |
          mkdir -p $GITHUB_WORKSPACE/zap-scan-results
          cp zap-reports/*.html $GITHUB_WORKSPACE/zap-scan-results/ 2>/dev/null || true
          cp zap-reports/*.json $GITHUB_WORKSPACE/zap-scan-results/ 2>/dev/null || true
          cp zap-reports/*.xml $GITHUB_WORKSPACE/zap-scan-results/ 2>/dev/null || true
          echo "Reports saved to $GITHUB_WORKSPACE/zap-scan-results"

      - name: Display Scan Summary
        if: always()
        run: |
          echo "### ðŸ”’ ZAP Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Scan completed on Windows ZAP Server via AWS Systems Manager" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ Target: DVWA at http://13.49.91.130" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ Method: AWS SSM (No SSH ports exposed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Reports Available:**" >> $GITHUB_STEP_SUMMARY
          echo "- Download from Artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "- View in ZAP GUI: RDP to 51.21.57.0" >> $GITHUB_STEP_SUMMARY

  zap-full-scan:
    name: ZAP Full Scan
    runs-on: ubuntu-latest
    # Run only on manual trigger or schedule to avoid long scan times on every push
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create ZAP reports directory
        run: mkdir -p zap-reports

      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: ${{ env.TARGET_URL }}
          rules_file_name: 'zap-rules.tsv'
          cmd_options: '-a -j -l INFO'
          issue_title: 'ZAP Full Scan Report'
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_action: false
          allow_issue_writing: true

      - name: Upload ZAP Full Scan Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-scan-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

  zap-api-scan:
    name: ZAP API Scan
    runs-on: ubuntu-latest
    # Only run if API definition exists
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for API definition
        id: check_api
        run: |
          if [ -f "openapi.json" ] || [ -f "swagger.json" ] || [ -f "openapi.yaml" ]; then
            echo "api_exists=true" >> $GITHUB_OUTPUT
          else
            echo "api_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ZAP API Scan
        if: steps.check_api.outputs.api_exists == 'true'
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: ${{ env.TARGET_URL }}
          format: 'openapi'
          api_definition_url: '${{ env.TARGET_URL }}/v3/api-docs'
          rules_file_name: 'zap-rules.tsv'
          cmd_options: '-a -j -l INFO'
          issue_title: 'ZAP API Scan Report'
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_action: false
          allow_issue_writing: true

      - name: Upload ZAP API Scan Report
        uses: actions/upload-artifact@v4
        if: always() && steps.check_api.outputs.api_exists == 'true'
        with:
          name: zap-api-scan-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

  zap-custom-scan:
    name: ZAP Custom Docker Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull ZAP Docker Image
        run: docker pull ghcr.io/zaproxy/zaproxy:${{ env.ZAP_VERSION }}

      - name: Create workspace directory
        run: mkdir -p $(pwd)/zap-workspace

      - name: Run ZAP Spider Scan
        run: |
          docker run --rm \
            -v $(pwd)/zap-workspace:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:${{ env.ZAP_VERSION }} \
            zap-baseline.py \
            -t ${{ env.TARGET_URL }} \
            -r zap-spider-report.html \
            -J zap-spider-report.json \
            -w zap-spider-report.md \
            -a \
            -j \
            -l INFO \
            -d

      - name: Run ZAP Active Scan (if needed)
        run: |
          docker run --rm \
            -v $(pwd)/zap-workspace:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:${{ env.ZAP_VERSION }} \
            zap-full-scan.py \
            -t ${{ env.TARGET_URL }} \
            -r zap-active-report.html \
            -J zap-active-report.json \
            -w zap-active-report.md \
            -a \
            -j \
            -l INFO

      - name: Upload Custom Scan Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-custom-scan-reports
          path: zap-workspace/*.{html,json,md}
          retention-days: 30

  process-results:
    name: Process and Notify Results
    runs-on: ubuntu-latest
    needs: [zap-scan-via-ssm]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse ZAP Results
        id: parse_results
        run: |
          if [ -f "./zap-reports/report_json.json" ]; then
            HIGH=$(jq '[.site[].alerts[] | select(.riskcode == "3")] | length' ./zap-reports/report_json.json || echo "0")
            MEDIUM=$(jq '[.site[].alerts[] | select(.riskcode == "2")] | length' ./zap-reports/report_json.json || echo "0")
            LOW=$(jq '[.site[].alerts[] | select(.riskcode == "1")] | length' ./zap-reports/report_json.json || echo "0")
            INFO=$(jq '[.site[].alerts[] | select(.riskcode == "0")] | length' ./zap-reports/report_json.json || echo "0")
            
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            echo "info=$INFO" >> $GITHUB_OUTPUT
            
            echo "### ZAP Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- Medium: $MEDIUM" >> $GITHUB_STEP_SUMMARY
            echo "- Low: $LOW" >> $GITHUB_STEP_SUMMARY
            echo "- Informational: $INFO" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const high = '${{ steps.parse_results.outputs.high }}';
            const medium = '${{ steps.parse_results.outputs.medium }}';
            const low = '${{ steps.parse_results.outputs.low }}';
            const info = '${{ steps.parse_results.outputs.info }}';
            
            const comment = `## ðŸ”’ ZAP DAST Scan Results
            
            | Severity | Count |
            |----------|-------|
            | ðŸ”´ High | ${high} |
            | ðŸŸ  Medium | ${medium} |
            | ðŸŸ¡ Low | ${low} |
            | â„¹ï¸ Info | ${info} |
            
            [View detailed report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload All ZAP Reports (robust)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-reports
          path: zap-reports/
          retention-days: 90

      - name: Print Artifact Download Link
        if: always()
        run: |
          echo "### ðŸ“¥ [Download ZAP Scan Reports](../../artifacts)" >> $GITHUB_STEP_SUMMARY
