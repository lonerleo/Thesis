name: PetClinic ZAP DAST Scan

on:
  push:
    paths:
      - 'petclinic/**'
  pull_request:
    paths:
      - 'petclinic/**'
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan (optional, overrides default)'
        required: false
        type: string
  schedule:
    - cron: '0 2 * * *'

env:
  PETCLINIC_HOST: '13.49.91.130'
  PETCLINIC_PORT: '8082'
  ZAP_HOST: '51.21.57.0'
  TARGET_URL: ${{ inputs.target_url || 'http://13.49.91.130:8082/petclinic' }}
  ZAP_VERSION: 'stable'

jobs:
  deploy-petclinic:
    name: Deploy PetClinic Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.PETCLINIC_HOST }} >> ~/.ssh/known_hosts
      - name: Deploy PetClinic Application to EC2
        run: |
          echo "Deploying PetClinic to ${{ env.PETCLINIC_HOST }}..."
          ssh -i ~/.ssh/id_rsa ubuntu@${{ env.PETCLINIC_HOST }} << 'EOF'
            echo "Pulling latest PetClinic image..."
            sudo docker pull springcommunity/spring-petclinic-rest:latest
            echo "Stopping existing PetClinic container..."
            sudo docker stop $(sudo docker ps -q --filter ancestor=springcommunity/spring-petclinic-rest) || true
            sudo docker rm $(sudo docker ps -aq --filter ancestor=springcommunity/spring-petclinic-rest) || true
            echo "Starting new PetClinic container on port 8082..."
            sudo docker run -d --name petclinic -p 8082:9966 springcommunity/spring-petclinic-rest:latest
            echo "Waiting for PetClinic to be ready..."
            sleep 30
            echo "PetClinic deployment completed!"
          EOF
      - name: Verify PetClinic is Running
        run: |
          echo "Checking if PetClinic is accessible..."
          for i in {1..10}; do
            if curl -f -s -o /dev/null http://${{ env.PETCLINIC_HOST }}:${{ env.PETCLINIC_PORT }}/petclinic; then
              echo "âœ… PetClinic is up and running!"
              exit 0
            fi
            echo "Waiting for PetClinic... (attempt $i/10)"
            sleep 10
          done
          echo "âŒ PetClinic is not responding"
          exit 1

  zap-scan-via-ssm:
    name: ZAP Scan from Windows Server via SSM
    runs-on: ubuntu-latest
    needs: deploy-petclinic
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1
      - name: Run ZAP Scan via Systems Manager
        id: run-zap
        run: |
          echo "Triggering ZAP scan on Windows server via SSM..."
          echo "Target: PetClinic at ${{ env.PETCLINIC_HOST }}:${{ env.PETCLINIC_PORT }}"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.WINDOWS_INSTANCE_ID }}" \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["Get-Process java -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue; Start-Sleep -Seconds 2; if (-not (Test-Path \"C:\zap-reports\")) { New-Item -ItemType Directory -Path \"C:\zap-reports\" -Force | Out-Null }; cd \"C:\Program Files\ZAP\Zed Attack Proxy\"; Write-Host \"=== Running ZAP Full Scan ===\"; .\\zap.bat -cmd -zapit http://13.49.91.130:8082/petclinic -quickout \"C:\zap-reports\baseline-report.html\" -quickprogress *>&1 | Tee-Object \"C:\zap-reports\zap-output.txt\"; Write-Host \"=== Scan completed ===\"; if (Test-Path \"C:\zap-reports\baseline-report.html\") { Write-Host \"SUCCESS: Report created\"; $size = (Get-Item \"C:\zap-reports\baseline-report.html\").Length; Write-Host \"Report size: $size bytes\" } else { Write-Host \"ERROR: No report found\"; Write-Host \"Files in C:\zap-reports:\"; Get-ChildItem \"C:\zap-reports\" | Select-Object Name, Length; Write-Host \"--- zap-output.txt ---\"; if (Test-Path \"C:\zap-reports\zap-output.txt\") { Get-Content \"C:\zap-reports\zap-output.txt\" } }"]' \
            --timeout-seconds 600 \
            --output text \
            --query "Command.CommandId")
          echo "Command ID: $COMMAND_ID"
          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "Waiting for scan to complete..."
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.WINDOWS_INSTANCE_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            echo "Status: $STATUS (attempt $i/60)"
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 5
          done
          echo "=== ZAP Scan Output ==="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.WINDOWS_INSTANCE_ID }}" \
            --query 'StandardOutputContent' \
            --output text || echo "No output available"
          echo "âœ… ZAP scan completed on Windows server"
      - name: Download Reports from Windows Server
        run: |
          mkdir -p ./zap-reports
          COPY_COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.WINDOWS_INSTANCE_ID }}" \
            --document-name "AWS-RunPowerShellScript" \
            --parameters 'commands=["if (Test-Path \"C:\\zap-reports\\baseline-report.html\") { [Convert]::ToBase64String([System.IO.File]::ReadAllBytes(\"C:\\zap-reports\\baseline-report.html\")) } else { Write-Host \"REPORT_NOT_FOUND\" }"]' \
            --output text \
            --query "Command.CommandId")
          echo "Waiting for report download..."
          for i in {1..12}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COPY_COMMAND_ID" \
              --instance-id "${{ secrets.WINDOWS_INSTANCE_ID }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 5
          done
          REPORT_BASE64=$(aws ssm get-command-invocation \
            --command-id "$COPY_COMMAND_ID" \
            --instance-id "${{ secrets.WINDOWS_INSTANCE_ID }}" \
            --query 'StandardOutputContent' \
            --output text 2>/dev/null || echo "")
          echo "Report content preview: ${REPORT_BASE64:0:100}..."
          if [ ! -z "$REPORT_BASE64" ] && [ "$REPORT_BASE64" != "REPORT_NOT_FOUND" ]; then
            echo "$REPORT_BASE64" | tr -d '\n\r ' | base64 -d > ./zap-reports/baseline-report.html 2>/dev/null && \
              echo "âœ… Report downloaded successfully" || \
              echo "âš ï¸ Failed to decode report"
          else
            echo "âš ï¸ No report generated or report not found"
          fi
          ls -lh ./zap-reports/ || true
      - name: Upload ZAP Scan Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-petclinic-scan-reports
          path: |
            zap-reports/*.html
            zap-reports/*.json
            zap-reports/*.xml
            zap-reports/*.txt
          retention-days: 30
      - name: Save ZAP Scan Reports Locally
        if: always()
        run: |
          mkdir -p $GITHUB_WORKSPACE/zap-scan-results
          cp zap-reports/*.html $GITHUB_WORKSPACE/zap-scan-results/ 2>/dev/null || true
          cp zap-reports/*.json $GITHUB_WORKSPACE/zap-scan-results/ 2>/dev/null || true
          cp zap-reports/*.xml $GITHUB_WORKSPACE/zap-scan-results/ 2>/dev/null || true
          cp zap-reports/*.txt $GITHUB_WORKSPACE/zap-scan-results/ 2>/dev/null || true
          echo "Reports saved to $GITHUB_WORKSPACE/zap-scan-results"
      - name: Display Scan Summary
        if: always()
        run: |
          echo "### ðŸ”’ ZAP Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Scan completed on Windows ZAP Server via AWS Systems Manager" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ Target: PetClinic at http://${{ env.PETCLINIC_HOST }}:${{ env.PETCLINIC_PORT }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”’ Method: AWS SSM (No SSH ports exposed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Reports Available:**" >> $GITHUB_STEP_SUMMARY
          echo "- Download from Artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "- View in ZAP GUI: RDP to 51.21.57.0" >> $GITHUB_STEP_SUMMARY
          echo "- Reports saved in C:\zap-reports on the ZAP server" >> $GITHUB_STEP_SUMMARY
